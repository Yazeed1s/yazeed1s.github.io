<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=38391&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #8BB8D0;
        }
    </style>

    
    
    
    
    
    

    
    <title>Force Memory Cleanup on Crash in C Programs</title>
    <meta name="description" content="Does the main function return on abnormal exit?">
    <meta name="keywords" content='blog, linux, yazeed, coding, C, memory, Linux'>

    <meta property="og:url" content="http://localhost:38391/posts/force_memory_cleanup/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Force Memory Cleanup on Crash in C Programs">
    <meta property="og:description" content="Does the main function return on abnormal exit?">
    <meta property="og:image" content="/images/aa.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Force Memory Cleanup on Crash in C Programs">
    <meta name="twitter:description" content="Does the main function return on abnormal exit?">
    <meta property="twitter:domain" content="http://localhost:38391/posts/force_memory_cleanup/">
    <meta property="twitter:url" content="http://localhost:38391/posts/force_memory_cleanup/">
    <meta name="twitter:image" content="/images/aa.png">

    
    <link rel="canonical" href="http://localhost:38391/posts/force_memory_cleanup/" />

    <link rel="stylesheet" type="text/css" href="http://localhost:38391//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="http://localhost:38391//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="http://localhost:38391//css/dark.css">

    <script src="http://localhost:38391//js/svg-injector.min.js"></script>
    <script src="http://localhost:38391//js/feather-icons.min.js"></script>
    <script src="http://localhost:38391//js/main.js"></script>

    
    
    	
	
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="http://localhost:38391/">
                <img src="http://localhost:38391//images/aa.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="http://localhost:38391/">Yazeed</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="http://localhost:38391/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="http://localhost:38391/about/"><span data-feather='user'></span> About </a>
            </div>
            
            <div class="nav-link">
                <a href="http://localhost:38391/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="http://localhost:38391/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="http://localhost:38391/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/yazeed1s"><span data-feather='github'></span> github </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="http://localhost:38391/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="http://localhost:38391/about/"><span data-feather='user'></span> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="http://localhost:38391/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="http://localhost:38391/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="http://localhost:38391/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/yazeed1s"><span data-feather='github'></span> github </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Force Memory Cleanup on Crash in C Programs</h1>
        <small role="doc-subtitle">Does the main function return on abnormal exit?</small>
        <p class="post-date">
            December 17, 2023
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="http://localhost:38391/tags/c">C</a></li>
        
            <li class="post-tag"><a href="http://localhost:38391/tags/memory">memory</a></li>
        
            <li class="post-tag"><a href="http://localhost:38391/tags/linux">Linux</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <hr>
<p>As you might already know.. In C (and other compiled languages as well) the <code>main</code> function serves as the entry point for program execution. It controls program execution by directing the calls to whatever code lives inside its body sequentially. Typically, sane programmers craft cleanup code that gets executed at the end of the program to free any allocated resources and give it back to the OS. This is simply done by calling <code>free()</code> on heap allocated object(s) before the main routine returns and exits out.</p>
<hr>
<h2 id="why-end-of-main-cleanup-isnt-enough">Why End-of-Main Cleanup Isn&rsquo;t Enough</h2>
<p>In most cases, placing cleanup code at the end of the main function achieves what we want. However, this approach is guaranteed to work <strong>only</strong> if the program exits <strong>normally</strong> (with EXIT_SUCCESS value).</p>
<p>But what happens when things go wrong? Let&rsquo;s say your program crashes because it tries to dereference a NULL pointer (classic C politics). In this case, the OS will raise a SIGSEGV signal faster than you can say &lsquo;segmentation fault&rsquo;. Your carefully crafted cleanup code at the end of main? It&rsquo;s never going to run.</p>
<p>Lets look at this code for example:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">#include</span> <span style="color:#5e81ac;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#5e81ac;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">#include</span> <span style="color:#5e81ac;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#5e81ac;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">#include</span> <span style="color:#5e81ac;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#5e81ac;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">char</span> <span style="color:#81a1c1">*</span>buffer <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">int</span> <span style="color:#88c0d0">main</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">void</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// allocate 500 MB of memory
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#81a1c1">size_t</span> size <span style="color:#81a1c1">=</span> <span style="color:#b48ead">500</span> <span style="color:#81a1c1">*</span> <span style="color:#b48ead">1024</span> <span style="color:#81a1c1">*</span> <span style="color:#b48ead">1024</span><span style="color:#eceff4">;</span> <span style="color:#616e87;font-style:italic">// ~500 MB
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	buffer <span style="color:#81a1c1">=</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">char</span> <span style="color:#81a1c1">*</span><span style="color:#eceff4">)</span><span style="color:#88c0d0">malloc</span><span style="color:#eceff4">(</span>size<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>buffer <span style="color:#81a1c1">==</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Failed to allocate memory&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#81a1c1;font-weight:bold">return</span> EXIT_FAILURE<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Successfully allocated 500 MB of memory.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// do some stuff with *buffer*
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#616e87;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// access an invalid pointer
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#81a1c1">char</span> <span style="color:#81a1c1">*</span>invalid_ptr <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Accessing invalid pointer...</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1">*</span>invalid_ptr <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;x&#39;</span><span style="color:#eceff4">;</span> <span style="color:#616e87;font-style:italic">// this will cause a segmentation fault
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;about to cleanup and return...</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// clean up
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#88c0d0">free</span><span style="color:#eceff4">(</span>buffer<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Here&rsquo;s what&rsquo;s happening:</p>
<ul>
<li>We allocate a large chunk of memory (500 MB) using <code>malloc()</code>.</li>
<li>We then attempt to dereference a NULL pointer, which will cause a segmentation fault.</li>
<li>The cleanup code (<code>free(buffer)</code>) and the <code>return 0</code> statement are placed at the end of <code>main()</code>.</li>
</ul>
<p>Now, if we run this code, you might expect to see all the printf statements, including &ldquo;about to cleanup and return&hellip;&rdquo;, but you&rsquo;re wrong. Here&rsquo;s what actually gets printed when I run the program:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc signal_crash.c -o out <span style="color:#81a1c1">&amp;&amp;</span> ./out
</span></span><span style="display:flex;"><span>Successfully allocated <span style="color:#b48ead">500</span> MB of memory.
</span></span><span style="display:flex;"><span>Accessing invalid pointer...
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">[</span>1<span style="color:#81a1c1">]</span> <span style="color:#b48ead">117619</span> segmentation fault <span style="color:#81a1c1">(</span>core dumped<span style="color:#81a1c1">)</span> ./out
</span></span></code></pre></div><p>See? the program never reaches the line <code>printf(&quot;about to cleanup and return...\n&quot;);</code>. In fact, it never passes the <code>*invalid_ptr = 'x';</code> line. Our free statement, which was supposed to cleanup, is never getting called into action because the code crashes with a SIGSEGV signal.</p>
<h2 id="okay-i-get-it-now-how-can-i-force-the-cleanup-code-to-execute">Okay I get it, now how can I force the cleanup code to execute?</h2>
<p>Some people think that the use of <a href="https://en.cppreference.com/w/c/program/atexit">atexit()</a> function provided by <code>&lt;stdlib.h&gt;</code> will solve this issue. But the thing is, <code>atexit()</code> takes a pointer to a function and then execeute that function when the program exits <strong>normally</strong>. It clearly does not solve our issue.</p>
<p>To force memory cleanup when the program crashes, a simple signal handler is needed. Don&rsquo;t panic, It is as simple as adding the following lines to our example.</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">#include</span> <span style="color:#5e81ac;font-style:italic">&lt;signal.h&gt;</span><span style="color:#5e81ac;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">#include</span> <span style="color:#5e81ac;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#5e81ac;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">#include</span> <span style="color:#5e81ac;font-style:italic">&lt;stdlib.h&gt;</span><span style="color:#5e81ac;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic">#include</span> <span style="color:#5e81ac;font-style:italic">&lt;unistd.h&gt;</span><span style="color:#5e81ac;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#5e81ac;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic">// array of signals we want to handle
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span><span style="color:#81a1c1">int</span> signals<span style="color:#eceff4">[]</span> <span style="color:#81a1c1">=</span> <span style="color:#eceff4">{</span>SIGINT<span style="color:#eceff4">,</span> SIGTERM<span style="color:#eceff4">,</span> SIGSEGV<span style="color:#eceff4">,</span> SIGABRT<span style="color:#eceff4">};</span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">char</span> <span style="color:#81a1c1">*</span>buffer <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">void</span> <span style="color:#88c0d0">cleanup</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">int</span> sig<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Caught signal %d. Cleaning up...</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">,</span> sig<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>sig <span style="color:#81a1c1">==</span> SIGINT<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;SIGINT received. User interrupted the program.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span> <span style="color:#81a1c1;font-weight:bold">else</span> <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>sig <span style="color:#81a1c1">==</span> SIGTERM<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;SIGTERM received. Program is being terminated.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span> <span style="color:#81a1c1;font-weight:bold">else</span> <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>sig <span style="color:#81a1c1">==</span> SIGSEGV<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;SIGSEGV received. Segmentation fault occurred.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span> <span style="color:#81a1c1;font-weight:bold">else</span> <span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>sig <span style="color:#81a1c1">==</span> SIGABRT<span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;SIGABRT received. Program execution aborted.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span> <span style="color:#81a1c1;font-weight:bold">else</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Unexpected signal received.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// free up buffer
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>buffer <span style="color:#81a1c1">!=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">free</span><span style="color:#eceff4">(</span>buffer<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Freed buffer.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>		buffer <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Cleanup complete. Exiting program.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">exit</span><span style="color:#eceff4">(</span><span style="color:#b48ead">1</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">void</span> <span style="color:#88c0d0">register_signals</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">void</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1">int</span> n <span style="color:#81a1c1">=</span> <span style="color:#81a1c1;font-weight:bold">sizeof</span><span style="color:#eceff4">(</span>signals<span style="color:#eceff4">)</span> <span style="color:#81a1c1">/</span> <span style="color:#81a1c1;font-weight:bold">sizeof</span><span style="color:#eceff4">(</span>signals<span style="color:#eceff4">[</span><span style="color:#b48ead">0</span><span style="color:#eceff4">]);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">for</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">int</span> i <span style="color:#81a1c1">=</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">;</span> i <span style="color:#81a1c1">&lt;</span> n<span style="color:#eceff4">;</span> i<span style="color:#81a1c1">++</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#88c0d0">signal</span><span style="color:#eceff4">(</span>signals<span style="color:#eceff4">[</span>i<span style="color:#eceff4">],</span> cleanup<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#81a1c1">int</span> <span style="color:#88c0d0">main</span><span style="color:#eceff4">(</span><span style="color:#81a1c1">void</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// register signal handler
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#88c0d0">register_signals</span><span style="color:#eceff4">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// allocate 500 MB of memory
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#81a1c1">size_t</span> size <span style="color:#81a1c1">=</span> <span style="color:#b48ead">500</span> <span style="color:#81a1c1">*</span> <span style="color:#b48ead">1024</span> <span style="color:#81a1c1">*</span> <span style="color:#b48ead">1024</span><span style="color:#eceff4">;</span> <span style="color:#616e87;font-style:italic">// ~500 MB
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	buffer <span style="color:#81a1c1">=</span> <span style="color:#eceff4">(</span><span style="color:#81a1c1">char</span> <span style="color:#81a1c1">*</span><span style="color:#eceff4">)</span><span style="color:#88c0d0">malloc</span><span style="color:#eceff4">(</span>size<span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">if</span> <span style="color:#eceff4">(</span>buffer <span style="color:#81a1c1">==</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">)</span> <span style="color:#eceff4">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Failed to allocate memory&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> EXIT_FAILURE<span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#eceff4">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Successfully allocated 500 MB of memory.</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// do some stuff with *buffer*
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#616e87;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#616e87;font-style:italic">// access an invalid pointer
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>	<span style="color:#81a1c1">char</span> <span style="color:#81a1c1">*</span>invalid_ptr <span style="color:#81a1c1">=</span> <span style="color:#81a1c1">NULL</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#88c0d0">printf</span><span style="color:#eceff4">(</span><span style="color:#a3be8c">&#34;Accessing invalid pointer...</span><span style="color:#ebcb8b">\n</span><span style="color:#a3be8c">&#34;</span><span style="color:#eceff4">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1">*</span>invalid_ptr <span style="color:#81a1c1">=</span> <span style="color:#a3be8c">&#39;x&#39;</span><span style="color:#eceff4">;</span> <span style="color:#616e87;font-style:italic">// this will cause a segmentation fault
</span></span></span><span style="display:flex;"><span><span style="color:#616e87;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#81a1c1;font-weight:bold">return</span> <span style="color:#b48ead">0</span><span style="color:#eceff4">;</span>
</span></span><span style="display:flex;"><span><span style="color:#eceff4">}</span>
</span></span></code></pre></div><p>Here is what changed:</p>
<ul>
<li>I defined an array names <code>signals</code> that stores the signal we are interested in (SIGINT, SIGTERM, SIGSEGV, SIGABRT)</li>
<li>Then I implemented the <code>cleanup()</code> function to handle these signals, which prints messages and frees the buffer.</li>
<li>Then I iterated through the array in <code>register_signals()</code> and registered the cleanup function to handle each signal.</li>
</ul>
<p>When we run this updated code, we should see the cleanup messages printed after the segmentation fault occurs.</p>
<p>Here is the output:</p>
<div class="highlight"><pre tabindex="0" style="color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc signal_crash.c -o out <span style="color:#81a1c1">&amp;&amp;</span> ./out
</span></span><span style="display:flex;"><span>Successfully allocated <span style="color:#b48ead">500</span> MB of memory.
</span></span><span style="display:flex;"><span>Accessing invalid pointer...
</span></span><span style="display:flex;"><span>Caught signal 11. Cleaning up...
</span></span><span style="display:flex;"><span>SIGSEGV received. Segmentation fault occurred.
</span></span><span style="display:flex;"><span>Freed buffer.
</span></span><span style="display:flex;"><span>Cleanup complete. Exiting program.
</span></span></code></pre></div><p>Now, by implementing this simple signal handling mechanism we are telling the operating system to associate the signal number with the function handler <code>cleanup()</code> so that when that signal number is raised (e.g., when the user presses Ctrl+C for SIGINT) our signal handler function will be called. Which also means, our cleanup code will be executed regardless of the program exit circumstances. Goal achieved!!</p>
<hr>
<h2 id="but-hey-doesnt-the-os-clean-up-after-crashed-programs">But hey doesn&rsquo;t the OS clean up after crashed programs?</h2>
<p>That&rsquo;s a great question! The answer isn&rsquo;t as straightforward as we might hope.</p>
<p>In general, modern OSs are pretty good at cleaning up after crashed programs, but it&rsquo;s not 100% guaranteed in all cases. For most typical program crashes, yes, the OS will step in and free up the memory that was allocated to the program and reclaim other resources. But (there&rsquo;s always a but, right?), there are some scenarios where things can get messy due to extremely abnormal terminations.</p>
<p>To be honest: I don&rsquo;t care about relying on the OS for cleanup, and you shouldn&rsquo;t either. It&rsquo;s still our responsibility as developers to manage our resources properly and not rely on the OS to bail us out.</p>
<hr>

        </p>
    </div>

    <div class="prev-next">
        
            
                


<div class="next-post">
    <p>
        <a href="http://localhost:38391/posts/bsp/">
            Next:
            The Inner workings of BSP-Trees in the context of window management
            &#8594;
        </a>
    </p>
        <p class="next-post-date">
            July 21, 2024
        </p>
</div>


            
        
    </div>
</div>



    

        </main><footer class="footer">
	
	<span>
		
		
		
	</span>
</footer></body>
</html>
